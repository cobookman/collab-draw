<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="shared-styles.html">

<dom-module id="my-canvas">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      canvas  {
        /** DO NOT SET WIDTH & HEIGHT HERE.
          ONLY SET DIRECTLY ON CANVAS ELEMENT. **/
        border: 2px solid black;
      }
    </style>

    <app-route
           route="{{route}}"
           pattern="/:id"
           data="{{data}}">
    </app-route>
    <div class="card">
      <h1>Canvas #{{data.id}}</h1>
      <h3>
        <span hidden="{{!connected}}">Connected to websocket</span>
        <span hidden="{{connected}}">Not Connected to websocket</span>
      </h3>
      <canvas id="canvas" width="400" height="400"></canvas>
    </div>

    <iron-ajax
      id="hostIp"
      method="POST"
      body="{}"
      on-response="onHostIp"
      handle-as="json">
    </iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'my-canvas',
      listeners: {
        'canvas.down': 'onDraw',
        'canvas.up': 'onDraw',
        'canvas.track': 'onDraw'
      },
      properties: {
        connected: {
          type: Boolean,
          notify: true,
          value: false
        },
        websocketHost: {
          type: String,
          notify: false,
          value: function() {
            var host = "" + window.location.host;
            host = host.replace("www.", "");
            host = "drawings-dot-" + host;
            return window.location.protocol + "//" + host;
          }
        }
      },
      observers: [
        "_routeChanged(route.path)"
      ],
      _routeChanged: function(changeRecord) {
        if(!changeRecord || changeRecord == "/") {
          alert("Unknown canvasId");
        }
      },
      ready: function() {
        window.location.host;
        this.$.hostIp.url = this.websocketHost + "/ipaddr";
        this.$.hostIp.generateRequest();
        this.initCanvas()
      },
      onHostIp: function(data) {
        if(!data || !data.detail || !data.detail.response.wsip) {
          alert("No host for websockets connection");
        } else {
          if (this.ws) {
            this.ws.close();
          }

          console.log("Opening a connection to: ws://" + data.detail.response.wsip + "/canvas");
          this.ws = new WebSocket("ws://" + data.detail.response.wsip + "/canvas?canvasId=" + this.data.id);

          this.ws.onopen = function() {
            console.log("Connected to ws");
            this.set("connected", true);
          }.bind(this);

          this.ws.onclose = function() {
            console.log("Disconnected to ws");
            this.set("conneccted", false);
            this.ws = null;
          }.bind(this);

          this.ws.onmessage = function(evt) {
            this.onUpstreamMessage(evt.data);
          }.bind(this);
        }
      },
      initCanvas: function() {
        this.ctx = this.$.canvas.getContext("2d");
        this.canvasWidth = this.$.canvas.width;
        this.canvasHeight = this.$.canvas.height;
        this.oldPoint = {x: 0, y: 0};
        this.lineWidth = 2;
        this.lineStyle = "black";
        this.pointbuf = [];
      },
      onDraw: function(e) {
        if (e.type == "down" || e.type == "track") {
          var bounds = this.$.canvas.getBoundingClientRect();
          var point = {
            x: Math.round(e.detail.x - bounds.left),
            y: Math.round(e.detail.y - bounds.top)
          };

          if (e.type == "track") {
            this.drawLine(this.oldPoint, point);
          } else if (e.type == "down") {
            this.pointbuf = [];
            this.drawDot(point);
          }
          this.oldPoint = point;
          this.pointbuf.push(point);
        } else if (e.type == "up") {
          // send drawn points downstream
          var data = JSON.stringify({
            canvasId: this.data.id,
            points: this.pointbuf,
          });
          console.log("sending drawing: ", data);
          this.ws.send(data);
          this.pointbuf = [];
        } else {
          console.error("Unknown event type of: ", e.type, e);
        }
      },
      drawDot: function(point) {
        this.ctx.beginPath();
        this.ctx.fillStyle = this.lineStyle;
        this.ctx.fillRect(point.x, point.y, this.lineWidth, this.lineWidth);
        this.ctx.closePath();
      },
      onUpstreamMessage: function(message) {
        if (typeof(message) != "object") {
          message = JSON.parse(message);
        }

        console.log("upstream message: ", message);
        if (!message || !message.type || message.type.toLowerCase() != "drawing") {
          console.log("Not a drawing message, disregarding");
          return;
        }

        if (!message.data || !message.data.points) {
          console.log("no points in message");
          return;
        }

        var oldPoint = null;
        message.data.points.forEach((point) => {
          if (!oldPoint) {
            this.drawDot(point);
          } else {
            this.drawLine(oldPoint, point)
          }
          oldPoint = point;
        });
      },
      drawLine: function(point1, point2) {
        this.ctx.beginPath();
        this.ctx.moveTo(point1.x, point1.y);
        this.ctx.lineTo(point2.x, point2.y);
        this.ctx.strokeStyle = this.lineStyle;
        this.ctx.lineWidth = this.lineWidth;
        this.ctx.stroke();
        this.ctx.closePath();
      },
    });
  </script>
</dom-module>
